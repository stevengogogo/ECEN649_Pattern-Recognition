
## Problem 6.12

``` python
import tensorflow as tf
import numpy as np
import PIL
import cv2
import os
import sklearn
import pandas as pd
import pickle
import platform
from tqdm.notebook import tqdm
from sklearn.multiclass import OneVsOneClassifier
from sklearn import preprocessing
from sklearn import svm
from sklearn.pipeline import make_pipeline
from sklearn.preprocessing import StandardScaler
from scipy import stats as st
```

### Computational Environment

``` python
physical_devices = tf.config.list_physical_devices('GPU')
my_system = platform.uname()
print(physical_devices)
print(f"System: {my_system.system}")
print(f"Node Name: {my_system.node}")
print(f"Release: {my_system.release}")
print(f"Version: {my_system.version}")
print(f"Machine: {my_system.machine}")
print(f"Processor: {my_system.processor}")
```

    [PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU')]
    System: Darwin
    Node Name: client-10-228-18-202.tamulink.tamu.edu
    Release: 21.5.0
    Version: Darwin Kernel Version 21.5.0: Tue Apr 26 21:08:29 PDT 2022; root:xnu-8020.121.3~4/RELEASE_ARM64_T8101
    Machine: arm64
    Processor: i386

### Helper function

``` python
def load_image(path, width=484, preprocess_input=tf.keras.applications.vgg16.preprocess_input):
    """
    Load and Preprocessing image
    """
    img = tf.keras.utils.load_img(path)
    x = tf.keras.utils.img_to_array(img)
    x = x[0:width,:,:]
    x = np.expand_dims(x, axis=0)
    return tf.keras.applications.vgg16.preprocess_input(x)
```

### Data inspectation

``` python
dpath = os.path.join("data", "CMU-UHCS_Dataset")
pic_path = os.path.join(dpath, "images")
df_micro = pd.read_csv( os.path.join(dpath, "micrograph.csv"))
df_micro = df_micro[["path", "primary_microconstituent"]]

for i in range(0, len(df_micro)):
    img_ph = os.path.join(pic_path,df_micro.iloc[i][0])
    assert os.path.exists(img_ph)
    df_micro.iloc[i][0] = img_ph
df_micro2 = df_micro.copy()
CLS_rm = ["pearlite+widmanstatten", "martensite", "pearlite+spheroidite"] #(type, sample size)
```

``` python
for c in CLS_rm:
    df_micro.drop(df_micro[df_micro["primary_microconstituent"] == c].index, inplace=True)
```

``` python
# labels
name_lbs = df_micro["primary_microconstituent"].unique()
le = preprocessing.LabelEncoder()
le.fit(name_lbs)
list(le.classes_)
```

    ['network', 'pearlite', 'spheroidite', 'spheroidite+widmanstatten']

``` python
dlabel = le.transform(df_micro["primary_microconstituent"])
df_micro.insert(2, "label", dlabel)
df_micro
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>path</th>
      <th>primary_microconstituent</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1.tif</td>
      <td>pearlite</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph2.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph5.tif</td>
      <td>pearlite</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph6.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>5</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph7.tif</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>955</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1722.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>957</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1726.tif</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>958</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1730.png</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>959</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1731.tif</td>
      <td>pearlite</td>
      <td>1</td>
    </tr>
    <tr>
      <th>960</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1732.tif</td>
      <td>pearlite</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>791 rows × 3 columns</p>
</div>

### Data Processing

``` python
# Train-test split
df_test = df_micro.copy()
df_train = pd.DataFrame(columns = df_micro.keys())

split_info = [("spheroidite", 100),\
              ("network", 100),\
              ("pearlite", 100),\
              ("spheroidite+widmanstatten", 60)] #(type, sample size)



for ln in split_info:
    label, n = ln
    id_train = df_micro[df_micro["primary_microconstituent"] == label][0:n].index
    df_test.drop(id_train, axis=0, inplace=True)
    df_train = pd.concat([df_train, df_micro.loc[id_train]])
```

``` python
df_train
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>path</th>
      <th>primary_microconstituent</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph2.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph6.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>8</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph10.png</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>9</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph11.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>20</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph29.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>596</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1093.tif</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>618</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1129.tif</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>631</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1156.tif</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>672</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1218.tif</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>673</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1219.tif</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
<p>360 rows × 3 columns</p>
</div>

``` python
df_test
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>path</th>
      <th>primary_microconstituent</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>237</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph436.png</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>238</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph437.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>239</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph440.png</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>241</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph442.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>242</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph443.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>955</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1722.tif</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>957</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1726.tif</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>958</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1730.png</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>959</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1731.tif</td>
      <td>pearlite</td>
      <td>1</td>
    </tr>
    <tr>
      <th>960</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1732.tif</td>
      <td>pearlite</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>431 rows × 3 columns</p>
</div>

### Feature Extraction

``` python
# VGG16

base_model = tf.keras.applications.vgg16.VGG16(
    include_top=False,
    weights='imagenet',
    input_tensor=None,
    input_shape=None,
    pooling=None,
    classes=1000,
    classifier_activation='softmax'
)

base_model.summary()
```

    Model: "vgg16"
    _________________________________________________________________
     Layer (type)                Output Shape              Param #   
    =================================================================
     input_1 (InputLayer)        [(None, None, None, 3)]   0         
                                                                     
     block1_conv1 (Conv2D)       (None, None, None, 64)    1792      
                                                                     
     block1_conv2 (Conv2D)       (None, None, None, 64)    36928     
                                                                     
     block1_pool (MaxPooling2D)  (None, None, None, 64)    0         
                                                                     
     block2_conv1 (Conv2D)       (None, None, None, 128)   73856     
                                                                     
     block2_conv2 (Conv2D)       (None, None, None, 128)   147584    
                                                                     
     block2_pool (MaxPooling2D)  (None, None, None, 128)   0         
                                                                     
     block3_conv1 (Conv2D)       (None, None, None, 256)   295168    
                                                                     
     block3_conv2 (Conv2D)       (None, None, None, 256)   590080    
                                                                     
     block3_conv3 (Conv2D)       (None, None, None, 256)   590080    
                                                                     
     block3_pool (MaxPooling2D)  (None, None, None, 256)   0         
                                                                     
     block4_conv1 (Conv2D)       (None, None, None, 512)   1180160   
                                                                     
     block4_conv2 (Conv2D)       (None, None, None, 512)   2359808   
                                                                     
     block4_conv3 (Conv2D)       (None, None, None, 512)   2359808   
                                                                     
     block4_pool (MaxPooling2D)  (None, None, None, 512)   0         
                                                                     
     block5_conv1 (Conv2D)       (None, None, None, 512)   2359808   
                                                                     
     block5_conv2 (Conv2D)       (None, None, None, 512)   2359808   
                                                                     
     block5_conv3 (Conv2D)       (None, None, None, 512)   2359808   
                                                                     
     block5_pool (MaxPooling2D)  (None, None, None, 512)   0         
                                                                     
    =================================================================
    Total params: 14,714,688
    Trainable params: 14,714,688
    Non-trainable params: 0
    _________________________________________________________________

Use five layers

``` python
out_layer_ns = ["block{}_pool".format(i) for i in range(1,6)]
out_layer_ns
```

    ['block1_pool', 'block2_pool', 'block3_pool', 'block4_pool', 'block5_pool']

``` python
# Construct 5 models for feature extraction
extmodel = dict(zip(out_layer_ns, [tf.keras.Model(
    inputs= base_model.input,
    outputs=base_model.get_layer(bk_name).output
) for bk_name in out_layer_ns]))

extmodel
```

    {'block1_pool': <keras.engine.functional.Functional at 0x29f411e20>,
     'block2_pool': <keras.engine.functional.Functional at 0x2af72ecd0>,
     'block3_pool': <keras.engine.functional.Functional at 0x2b06b63d0>,
     'block4_pool': <keras.engine.functional.Functional at 0x2b06be5b0>,
     'block5_pool': <keras.engine.functional.Functional at 0x2b06bedf0>}

``` python
# Display output dimensions
out_shapes = [extmodel[m].output_shape[-1] for m in extmodel.keys()]
out_shapes
```

    [64, 128, 256, 512, 512]

``` python
# Initiate feature maps for testing and training
fs_train = [np.zeros((df_train.shape[0], n_f)) for n_f in out_shapes]
fs_test = [np.zeros((df_test.shape[0], n_f)) for n_f in out_shapes]

features_train = dict(zip(out_layer_ns, fs_train))
features_test = dict(zip(out_layer_ns, fs_test))

features_train
```

    {'block1_pool': array([[0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            ...,
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.]]),
     'block2_pool': array([[0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            ...,
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.]]),
     'block3_pool': array([[0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            ...,
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.]]),
     'block4_pool': array([[0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            ...,
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.]]),
     'block5_pool': array([[0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            ...,
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.],
            [0., 0., 0., ..., 0., 0., 0.]])}

``` python
# Feature extraction with VGG16
if os.path.exists(os.path.join(dpath, "feature_train.pkl")) == False:
    for m in tqdm(extmodel.keys()):
        for i, df in enumerate([df_train, df_test]):
            for j, ph in tqdm(enumerate(df["path"])):
                x = load_image(ph)
                xb = extmodel[m].predict(x, verbose = 0) # silence output
                F = np.mean(xb,axis=(0,1,2))
                # Save features
                if i ==0:
                    features_train[m][j, :] = F
                else:
                    features_test[m][j, :] = F
    #save file
    paths =  dict(zip(["train", "test"],\
        [os.path.join(dpath, "feature_{}.pkl".format(n))\
         for n in ["train", "test"]]))
    ## Create new files
    f_train = open(paths["train"], "wb")
    f_test = open(paths["test"], "wb")
    ## Write
    pickle.dump(features_train, f_train)
    pickle.dump(features_test, f_test)
    ## Close files
    f_train.close()
    f_test.close()
```

### SVM

``` python
# load data
ftn = open(paths["train"], "rb")
ftt = open(paths["test"], "rb")
featn = pickle.load(ftn) # train feature
featt = pickle.load(ftt) # test feature
ftn.close()
ftt.close()

# label
ltrain = df_train[["primary_microconstituent", "label"]].reset_index()
ltest = df_test[["primary_microconstituent", "label"]].reset_index()
```

``` python
ltrain
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>primary_microconstituent</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>20</td>
      <td>spheroidite</td>
      <td>2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>355</th>
      <td>596</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>356</th>
      <td>618</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>357</th>
      <td>631</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>358</th>
      <td>672</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
    <tr>
      <th>359</th>
      <td>673</td>
      <td>spheroidite+widmanstatten</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
<p>360 rows × 3 columns</p>
</div>

``` python
ltest["label"].to_numpy()
```

    array([2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
           2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
           2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
           2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 2,
           0, 2, 2, 0, 2, 0, 2, 0, 2, 2, 2, 2, 2, 2, 0, 2, 2, 0, 2, 2, 2, 0,
           0, 0, 2, 2, 0, 2, 2, 0, 2, 0, 2, 2, 0, 0, 0, 0, 2, 0, 0, 2, 2, 2,
           2, 2, 0, 0, 2, 2, 0, 2, 2, 2, 2, 0, 2, 2, 0, 0, 2, 2, 2, 2, 0, 2,
           0, 2, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0,
           0, 2, 2, 2, 2, 0, 0, 2, 2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 2, 2, 2, 2,
           2, 2, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 2, 2, 2, 2, 2, 2, 0, 0,
           2, 0, 2, 2, 0, 2, 0, 2, 2, 3, 0, 2, 2, 0, 3, 2, 2, 0, 0, 2, 0, 2,
           0, 2, 2, 2, 2, 0, 2, 3, 0, 2, 0, 2, 0, 3, 2, 0, 2, 0, 2, 2, 2, 3,
           2, 2, 0, 0, 2, 2, 0, 2, 2, 2, 3, 2, 0, 2, 0, 2, 2, 2, 2, 2, 2, 0,
           0, 2, 0, 2, 0, 0, 2, 0, 3, 0, 2, 2, 2, 2, 3, 3, 0, 2, 0, 0, 2, 0,
           0, 2, 2, 2, 0, 2, 1, 2, 0, 2, 2, 0, 0, 0, 3, 1, 3, 1, 0, 2, 2, 1,
           0, 2, 2, 2, 2, 0, 2, 2, 2, 2, 3, 2, 2, 0, 1, 1, 2, 1, 3, 3, 1, 2,
           2, 0, 3, 0, 2, 0, 2, 2, 2, 3, 0, 2, 2, 2, 0, 0, 3, 1, 1, 1, 0, 1,
           3, 0, 1, 2, 2, 3, 2, 2, 0, 2, 2, 0, 2, 0, 2, 2, 2, 1, 1, 2, 1, 2,
           2, 2, 1, 1, 0, 0, 2, 1, 2, 3, 2, 2, 2, 0, 2, 2, 2, 2, 1, 1, 0, 2,
           2, 0, 2, 2, 0, 0, 2, 1, 2, 3, 2, 1, 1])

``` python
featn["block1_pool"].shape
```

    (360, 64)

``` python
y = df_train["label"].to_numpy().astype(int)
y.shape
```

    (360,)

``` python
clf = svm.SVC(kernel="rbf", C=1., gamma="auto")
clf.fit(featn["block1_pool"], y)
```

<style>#sk-container-id-5 {color: black;background-color: white;}#sk-container-id-5 pre{padding: 0;}#sk-container-id-5 div.sk-toggleable {background-color: white;}#sk-container-id-5 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-5 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-5 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-5 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-5 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-5 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-5 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-5 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-5 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-5 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-5 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-5 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-5 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-5 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-5 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-5 div.sk-item {position: relative;z-index: 1;}#sk-container-id-5 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-5 div.sk-item::before, #sk-container-id-5 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-5 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-5 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-5 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-5 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-5 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-5 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-5 div.sk-label-container {text-align: center;}#sk-container-id-5 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-5 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-5" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>SVC(gamma=&#x27;auto&#x27;)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox" checked><label for="sk-estimator-id-5" class="sk-toggleable__label sk-toggleable__label-arrow">SVC</label><div class="sk-toggleable__content"><pre>SVC(gamma=&#x27;auto&#x27;)</pre></div></div></div></div></div>

``` python
clf.predict(featt["block1_pool"])
```

    array([2, 3, 2, 1, 2, 1, 2, 3, 2, 2, 1, 2, 2, 2, 2, 2, 2, 1, 2, 2, 2, 2,
           2, 3, 0, 2, 2, 2, 2, 0, 2, 2, 2, 3, 2, 2, 1, 2, 1, 2, 3, 2, 3, 2,
           2, 2, 3, 2, 3, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2, 0,
           3, 2, 2, 0, 1, 1, 1, 2, 3, 2, 0, 0, 3, 0, 2, 2, 0, 0, 0, 0, 2, 2,
           3, 2, 1, 3, 2, 2, 0, 0, 2, 1, 2, 2, 2, 3, 0, 2, 2, 0, 3, 2, 2, 2,
           3, 3, 2, 2, 0, 2, 2, 3, 2, 2, 2, 2, 2, 0, 0, 3, 0, 3, 0, 2, 2, 0,
           2, 1, 2, 0, 2, 2, 3, 2, 1, 2, 2, 0, 2, 2, 0, 2, 2, 2, 2, 2, 2, 2,
           0, 2, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 2, 0, 2, 1, 2, 2, 2, 2,
           0, 2, 2, 1, 2, 2, 0, 2, 2, 2, 0, 0, 3, 2, 2, 2, 2, 0, 2, 2, 2, 2,
           2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 2, 2, 1, 3, 2, 2, 2, 2, 2, 1, 2, 0,
           2, 2, 3, 2, 0, 0, 2, 2, 2, 2, 0, 2, 2, 2, 2, 2, 2, 0, 2, 2, 0, 2,
           0, 0, 3, 2, 2, 0, 2, 3, 2, 2, 0, 2, 0, 3, 2, 2, 2, 2, 1, 3, 3, 0,
           1, 2, 2, 0, 0, 2, 0, 2, 3, 2, 2, 2, 0, 2, 0, 2, 2, 1, 2, 2, 2, 0,
           0, 2, 2, 2, 3, 2, 2, 0, 2, 0, 2, 2, 3, 0, 3, 1, 0, 2, 3, 2, 2, 2,
           2, 2, 3, 2, 0, 3, 2, 2, 0, 2, 2, 2, 2, 0, 3, 2, 1, 1, 3, 2, 2, 1,
           0, 1, 2, 2, 2, 0, 2, 2, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 3, 2, 2,
           2, 2, 1, 2, 2, 3, 2, 2, 2, 0, 2, 3, 0, 2, 0, 0, 3, 1, 1, 1, 0, 1,
           2, 2, 1, 0, 2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 2, 2, 0, 1, 3, 2, 1, 2,
           2, 2, 2, 1, 2, 3, 2, 0, 2, 2, 2, 2, 0, 0, 1, 3, 0, 2, 1, 2, 3, 1,
           2, 2, 2, 2, 0, 0, 1, 1, 0, 3, 2, 1, 1])

#### One-to-One SVM

``` python
class One2OneSVM:
    def __init__(self, n_class=4):
        self.n_class = n_class
        self.clfs = [[svm.SVC(kernel="rbf", C=1., gamma="auto")\
                     for i in range(0,self.n_class)]\
                     for j in range(0,self.n_class)]
        self.cv = np.zeros((self.n_class,self.n_class))
    def train(self, ltrain, feature, fold=10):
        # traversal all features
        for i in range(0, self.n_class-1):
            lis = ltrain[ltrain["label"] == i].index.to_numpy()
            for j in range(i+1, self.n_class):
                ljs = ltrain[ltrain["label"] == j].index.to_numpy()
                # Data
                X = np.concatenate(\
                  (feature[lis,:],\
                   feature[ljs,:]), axis=0)
                Y = np.concatenate((np.ones(len(lis))*i,np.ones(len(ljs))*j))
                # Train SVM
                scores = sklearn.model_selection.cross_val_score(self.clfs[i][j], X, Y, cv=fold)
                self.clfs[i][j].fit(X,Y)
                self.cv[i][j] = np.max(scores)
                
    def test_1v1_error(self, ltest, feature):
        # traversal all features
        errM = np.zeros((self.n_class, self.n_class))
        for i in range(0, self.n_class-1):
            lis = ltest[ltest["label"] == i].index.to_numpy()
            for j in range(i+1, self.n_class):
                ljs = ltest[ltest["label"] == j].index.to_numpy()
                # Data
                X = np.concatenate(\
                  (feature[lis,:],\
                   feature[ljs,:]), axis=0)
                Y = np.concatenate((np.ones(len(lis))*i,np.ones(len(ljs))*j))
                # Train SVM
                y_pred = self.clfs[i][j].predict(X)
                errM[i,j] = error(Y, y_pred)
        return errM
        
    def predict(self, feature):
        predM = np.zeros(( int(self.n_class * (self.n_class -1)/2) , feature.shape[0]))
        c = 0
        for i in range(0, self.n_class-1):
            for j in range(i+1, self.n_class):
                predM[c,:] = self.clfs[i][j].predict(feature)
                c += 1
        return st.mode(predM, axis=0, keepdims=True).mode[0,:] #majority voting

def error(ans, pred):
    assert len(ans) == len(pred)
    return (ans != pred).sum()/float(ans.size)
```

### (a)

> The convolution layer used and the cross-validated error estimate for
> each of the six pairwise two-label classifiers

### (b)

> Separate test error rates on the unused micrographs of each of the
> four categories, for the pairwise two-label classifiers and the
> multilabel one-vs-one voting classifier described previously. For the
> pairwise classifiers use only the test micrographs with the two labels
> used to train the classifier. For the multilabel classifier, use the
> test micrographs with the corresponding four labels.

``` python
def df_cv(m, clf, info=""):
    var1 = []
    var2 = []
    cvs = []
    errs = []
    for i in range(0, m.shape[0]-1):
        for j in range(i+1, m.shape[0]):
            var1.append(i)
            var2.append(j)
            cvs.append(clf.cv[i,j])
            errs.append(m[i,j])
    infos = [info] * len(errs)
    return pd.DataFrame({"Info": infos, "Label 1": var1, "Label 2": var2, "Test error": errs,"Cross Validation Score": cvs})
```

#### Pair-wise classifier

``` python
df_errors = []
for b in out_layer_ns:
    clf1 = One2OneSVM()
    clf1.train(ltrain, features_train[b])
    errs = clf1.test_1v1_error(ltest, features_test[b])
    df_errors.append(df_cv(errs, clf1, b))
    
res_error = pd.concat(df_errors)
res_error
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Info</th>
      <th>Label 1</th>
      <th>Label 2</th>
      <th>Test error</th>
      <th>Cross Validation Score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>block1_pool</td>
      <td>0</td>
      <td>1</td>
      <td>0.823529</td>
      <td>0.500</td>
    </tr>
    <tr>
      <th>1</th>
      <td>block1_pool</td>
      <td>0</td>
      <td>2</td>
      <td>0.290155</td>
      <td>0.550</td>
    </tr>
    <tr>
      <th>2</th>
      <td>block1_pool</td>
      <td>0</td>
      <td>3</td>
      <td>0.157895</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>3</th>
      <td>block1_pool</td>
      <td>1</td>
      <td>2</td>
      <td>0.906040</td>
      <td>0.500</td>
    </tr>
    <tr>
      <th>4</th>
      <td>block1_pool</td>
      <td>1</td>
      <td>3</td>
      <td>0.466667</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>5</th>
      <td>block1_pool</td>
      <td>2</td>
      <td>3</td>
      <td>0.071186</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>0</th>
      <td>block2_pool</td>
      <td>0</td>
      <td>1</td>
      <td>0.823529</td>
      <td>0.650</td>
    </tr>
    <tr>
      <th>1</th>
      <td>block2_pool</td>
      <td>0</td>
      <td>2</td>
      <td>0.709845</td>
      <td>0.650</td>
    </tr>
    <tr>
      <th>2</th>
      <td>block2_pool</td>
      <td>0</td>
      <td>3</td>
      <td>0.157895</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>3</th>
      <td>block2_pool</td>
      <td>1</td>
      <td>2</td>
      <td>0.919463</td>
      <td>0.500</td>
    </tr>
    <tr>
      <th>4</th>
      <td>block2_pool</td>
      <td>1</td>
      <td>3</td>
      <td>0.466667</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>5</th>
      <td>block2_pool</td>
      <td>2</td>
      <td>3</td>
      <td>0.071186</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>0</th>
      <td>block3_pool</td>
      <td>0</td>
      <td>1</td>
      <td>0.823529</td>
      <td>0.600</td>
    </tr>
    <tr>
      <th>1</th>
      <td>block3_pool</td>
      <td>0</td>
      <td>2</td>
      <td>0.290155</td>
      <td>0.600</td>
    </tr>
    <tr>
      <th>2</th>
      <td>block3_pool</td>
      <td>0</td>
      <td>3</td>
      <td>0.157895</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>3</th>
      <td>block3_pool</td>
      <td>1</td>
      <td>2</td>
      <td>0.080537</td>
      <td>0.550</td>
    </tr>
    <tr>
      <th>4</th>
      <td>block3_pool</td>
      <td>1</td>
      <td>3</td>
      <td>0.466667</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>5</th>
      <td>block3_pool</td>
      <td>2</td>
      <td>3</td>
      <td>0.071186</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>0</th>
      <td>block4_pool</td>
      <td>0</td>
      <td>1</td>
      <td>0.823529</td>
      <td>0.500</td>
    </tr>
    <tr>
      <th>1</th>
      <td>block4_pool</td>
      <td>0</td>
      <td>2</td>
      <td>0.290155</td>
      <td>0.550</td>
    </tr>
    <tr>
      <th>2</th>
      <td>block4_pool</td>
      <td>0</td>
      <td>3</td>
      <td>0.157895</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>3</th>
      <td>block4_pool</td>
      <td>1</td>
      <td>2</td>
      <td>0.080537</td>
      <td>0.500</td>
    </tr>
    <tr>
      <th>4</th>
      <td>block4_pool</td>
      <td>1</td>
      <td>3</td>
      <td>0.466667</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>5</th>
      <td>block4_pool</td>
      <td>2</td>
      <td>3</td>
      <td>0.071186</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>0</th>
      <td>block5_pool</td>
      <td>0</td>
      <td>1</td>
      <td>0.073529</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>block5_pool</td>
      <td>0</td>
      <td>2</td>
      <td>0.033679</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>block5_pool</td>
      <td>0</td>
      <td>3</td>
      <td>0.060150</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>block5_pool</td>
      <td>1</td>
      <td>2</td>
      <td>0.000000</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>block5_pool</td>
      <td>1</td>
      <td>3</td>
      <td>0.088889</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>block5_pool</td>
      <td>2</td>
      <td>3</td>
      <td>0.061017</td>
      <td>0.875</td>
    </tr>
  </tbody>
</table>
</div>

#### Multiple one-vs-one classifier

``` python
# Multiclass one-vs-one
dfm_errors = []
for b in out_layer_ns:
    clf = OneVsOneClassifier(svm.SVC(kernel="rbf", C=1., gamma="auto").fit(features_train[b],\
          ltrain["label"].to_numpy(int)))
    clf.fit(features_train[b],\
          ltrain["label"].to_numpy(int))
    y_predm = clf.predict(features_test[b])
    dfm_errors.append(1 - error(y_predm, ltest["label"].to_numpy()))

# Display result
res_multi1v1 = pd.DataFrame({"Info": out_layer_ns, "Score": dfm_errors})
res_multi1v1
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Info</th>
      <th>Score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>block1_pool</td>
      <td>0.064965</td>
    </tr>
    <tr>
      <th>1</th>
      <td>block2_pool</td>
      <td>0.055684</td>
    </tr>
    <tr>
      <th>2</th>
      <td>block3_pool</td>
      <td>0.635731</td>
    </tr>
    <tr>
      <th>3</th>
      <td>block4_pool</td>
      <td>0.635731</td>
    </tr>
    <tr>
      <th>4</th>
      <td>block5_pool</td>
      <td>0.928074</td>
    </tr>
  </tbody>
</table>
</div>

### (c)

> For the mixed pearlite + spheroidite test micrographs, apply the
> trained pairwise classifier for pearlite vs. spheroidite and the
> multilabel voting classifier. Print the predicted labels by these two
> classifiers side by side (one row for each test micrograph). Comment
> your results

``` python
ltestm = ltest[(ltest["primary_microconstituent"] == "pearlite") |\
      (ltest["primary_microconstituent"] == "spheroidite")]
feature_m = features_test["block5_pool"][ltestm.index.to_numpy(), :]
l = le.transform(["pearlite", "spheroidite"])

pred_pairs = clf1.clfs[l[0]][l[1]].predict(feature_m)
pred_multi = clf.predict(feature_m)

res_ps = pd.DataFrame({"Test Label": le.inverse_transform(ltestm["label"]),\
              "Pairwise (pearlite vs. spheroidite)": le.inverse_transform(pred_pairs.astype(int)),\
              "Multi-OnevsOne": le.inverse_transform(pred_multi)})

print(res_ps.to_string())
```

          Test Label Pairwise (pearlite vs. spheroidite)             Multi-OnevsOne
    0    spheroidite                         spheroidite                spheroidite
    1    spheroidite                         spheroidite                spheroidite
    2    spheroidite                         spheroidite                spheroidite
    3    spheroidite                         spheroidite                spheroidite
    4    spheroidite                         spheroidite                spheroidite
    5    spheroidite                         spheroidite                spheroidite
    6    spheroidite                         spheroidite                spheroidite
    7    spheroidite                         spheroidite                spheroidite
    8    spheroidite                         spheroidite                spheroidite
    9    spheroidite                         spheroidite                spheroidite
    10   spheroidite                         spheroidite                spheroidite
    11   spheroidite                         spheroidite                spheroidite
    12   spheroidite                         spheroidite                spheroidite
    13   spheroidite                         spheroidite                spheroidite
    14   spheroidite                         spheroidite                spheroidite
    15   spheroidite                         spheroidite                spheroidite
    16   spheroidite                         spheroidite                spheroidite
    17   spheroidite                         spheroidite                spheroidite
    18   spheroidite                         spheroidite                spheroidite
    19   spheroidite                         spheroidite                spheroidite
    20   spheroidite                         spheroidite                spheroidite
    21   spheroidite                         spheroidite                spheroidite
    22   spheroidite                         spheroidite                spheroidite
    23   spheroidite                         spheroidite  spheroidite+widmanstatten
    24   spheroidite                         spheroidite                spheroidite
    25   spheroidite                         spheroidite                spheroidite
    26   spheroidite                         spheroidite                spheroidite
    27   spheroidite                         spheroidite  spheroidite+widmanstatten
    28   spheroidite                         spheroidite                spheroidite
    29   spheroidite                         spheroidite                spheroidite
    30   spheroidite                         spheroidite                spheroidite
    31   spheroidite                         spheroidite                spheroidite
    32   spheroidite                         spheroidite                spheroidite
    33   spheroidite                         spheroidite                spheroidite
    34   spheroidite                         spheroidite                spheroidite
    35   spheroidite                         spheroidite                spheroidite
    36   spheroidite                         spheroidite                spheroidite
    37   spheroidite                         spheroidite                spheroidite
    38   spheroidite                         spheroidite                spheroidite
    39   spheroidite                         spheroidite                spheroidite
    40   spheroidite                         spheroidite  spheroidite+widmanstatten
    41   spheroidite                         spheroidite                spheroidite
    42   spheroidite                         spheroidite                spheroidite
    43   spheroidite                         spheroidite                spheroidite
    44   spheroidite                         spheroidite                spheroidite
    45   spheroidite                         spheroidite                spheroidite
    46   spheroidite                         spheroidite                spheroidite
    47   spheroidite                         spheroidite                spheroidite
    48   spheroidite                         spheroidite                spheroidite
    49   spheroidite                         spheroidite                spheroidite
    50   spheroidite                         spheroidite                spheroidite
    51   spheroidite                         spheroidite                spheroidite
    52   spheroidite                         spheroidite                spheroidite
    53   spheroidite                         spheroidite                spheroidite
    54   spheroidite                         spheroidite                spheroidite
    55   spheroidite                         spheroidite                spheroidite
    56   spheroidite                         spheroidite                spheroidite
    57   spheroidite                         spheroidite                spheroidite
    58   spheroidite                         spheroidite                spheroidite
    59   spheroidite                         spheroidite                spheroidite
    60   spheroidite                         spheroidite                spheroidite
    61   spheroidite                         spheroidite                spheroidite
    62   spheroidite                         spheroidite                spheroidite
    63   spheroidite                         spheroidite                spheroidite
    64   spheroidite                         spheroidite                spheroidite
    65   spheroidite                         spheroidite                spheroidite
    66   spheroidite                         spheroidite                spheroidite
    67   spheroidite                         spheroidite                spheroidite
    68   spheroidite                         spheroidite                spheroidite
    69   spheroidite                         spheroidite                spheroidite
    70   spheroidite                         spheroidite                spheroidite
    71   spheroidite                         spheroidite                spheroidite
    72   spheroidite                         spheroidite                spheroidite
    73   spheroidite                         spheroidite                spheroidite
    74   spheroidite                         spheroidite                spheroidite
    75   spheroidite                         spheroidite                spheroidite
    76   spheroidite                         spheroidite                spheroidite
    77   spheroidite                         spheroidite                spheroidite
    78   spheroidite                         spheroidite                spheroidite
    79   spheroidite                         spheroidite                spheroidite
    80   spheroidite                         spheroidite                spheroidite
    81   spheroidite                         spheroidite                spheroidite
    82   spheroidite                         spheroidite                spheroidite
    83   spheroidite                         spheroidite                spheroidite
    84   spheroidite                         spheroidite                spheroidite
    85   spheroidite                         spheroidite                spheroidite
    86   spheroidite                         spheroidite                spheroidite
    87   spheroidite                         spheroidite                spheroidite
    88   spheroidite                         spheroidite                spheroidite
    89   spheroidite                         spheroidite                spheroidite
    90   spheroidite                         spheroidite  spheroidite+widmanstatten
    91   spheroidite                         spheroidite                spheroidite
    92   spheroidite                         spheroidite                spheroidite
    93   spheroidite                         spheroidite                spheroidite
    94   spheroidite                         spheroidite                spheroidite
    95   spheroidite                         spheroidite                spheroidite
    96   spheroidite                         spheroidite                spheroidite
    97   spheroidite                         spheroidite                spheroidite
    98   spheroidite                         spheroidite                spheroidite
    99   spheroidite                         spheroidite                spheroidite
    100  spheroidite                         spheroidite                spheroidite
    101  spheroidite                         spheroidite                spheroidite
    102  spheroidite                         spheroidite                spheroidite
    103  spheroidite                         spheroidite                spheroidite
    104  spheroidite                         spheroidite                spheroidite
    105  spheroidite                         spheroidite                spheroidite
    106  spheroidite                         spheroidite                spheroidite
    107  spheroidite                         spheroidite                spheroidite
    108  spheroidite                         spheroidite                spheroidite
    109  spheroidite                         spheroidite                spheroidite
    110  spheroidite                         spheroidite                spheroidite
    111  spheroidite                         spheroidite                spheroidite
    112  spheroidite                         spheroidite  spheroidite+widmanstatten
    113  spheroidite                         spheroidite                spheroidite
    114  spheroidite                         spheroidite                spheroidite
    115  spheroidite                         spheroidite                spheroidite
    116  spheroidite                         spheroidite                spheroidite
    117  spheroidite                         spheroidite                spheroidite
    118  spheroidite                         spheroidite                spheroidite
    119  spheroidite                         spheroidite                spheroidite
    120  spheroidite                         spheroidite                spheroidite
    121  spheroidite                         spheroidite                spheroidite
    122  spheroidite                         spheroidite                spheroidite
    123  spheroidite                         spheroidite                spheroidite
    124  spheroidite                         spheroidite                spheroidite
    125  spheroidite                         spheroidite                spheroidite
    126  spheroidite                         spheroidite                spheroidite
    127  spheroidite                         spheroidite                spheroidite
    128  spheroidite                         spheroidite                spheroidite
    129  spheroidite                         spheroidite                spheroidite
    130  spheroidite                         spheroidite                spheroidite
    131  spheroidite                         spheroidite                spheroidite
    132  spheroidite                         spheroidite                spheroidite
    133  spheroidite                         spheroidite                spheroidite
    134  spheroidite                         spheroidite                spheroidite
    135  spheroidite                         spheroidite                spheroidite
    136  spheroidite                         spheroidite                spheroidite
    137  spheroidite                         spheroidite                spheroidite
    138  spheroidite                         spheroidite                spheroidite
    139  spheroidite                         spheroidite                spheroidite
    140  spheroidite                         spheroidite                spheroidite
    141  spheroidite                         spheroidite                spheroidite
    142  spheroidite                         spheroidite                spheroidite
    143  spheroidite                         spheroidite                spheroidite
    144  spheroidite                         spheroidite                spheroidite
    145  spheroidite                         spheroidite                spheroidite
    146  spheroidite                         spheroidite                spheroidite
    147  spheroidite                         spheroidite                spheroidite
    148  spheroidite                         spheroidite                spheroidite
    149  spheroidite                         spheroidite                spheroidite
    150  spheroidite                         spheroidite                spheroidite
    151  spheroidite                         spheroidite                spheroidite
    152  spheroidite                         spheroidite                spheroidite
    153  spheroidite                         spheroidite                spheroidite
    154  spheroidite                         spheroidite                spheroidite
    155  spheroidite                         spheroidite                spheroidite
    156  spheroidite                         spheroidite                spheroidite
    157  spheroidite                         spheroidite                spheroidite
    158  spheroidite                         spheroidite                spheroidite
    159  spheroidite                         spheroidite                spheroidite
    160  spheroidite                         spheroidite                spheroidite
    161  spheroidite                         spheroidite                spheroidite
    162  spheroidite                         spheroidite                spheroidite
    163  spheroidite                         spheroidite                spheroidite
    164  spheroidite                         spheroidite                spheroidite
    165  spheroidite                         spheroidite                spheroidite
    166  spheroidite                         spheroidite                    network
    167  spheroidite                         spheroidite                spheroidite
    168  spheroidite                         spheroidite                spheroidite
    169  spheroidite                         spheroidite                spheroidite
    170  spheroidite                         spheroidite                spheroidite
    171  spheroidite                         spheroidite                spheroidite
    172  spheroidite                         spheroidite                spheroidite
    173  spheroidite                         spheroidite                spheroidite
    174  spheroidite                         spheroidite                spheroidite
    175  spheroidite                         spheroidite                spheroidite
    176  spheroidite                         spheroidite                spheroidite
    177  spheroidite                         spheroidite                spheroidite
    178  spheroidite                         spheroidite  spheroidite+widmanstatten
    179  spheroidite                         spheroidite                spheroidite
    180  spheroidite                         spheroidite                spheroidite
    181  spheroidite                         spheroidite                spheroidite
    182  spheroidite                         spheroidite                spheroidite
    183  spheroidite                         spheroidite                spheroidite
    184  spheroidite                         spheroidite                spheroidite
    185  spheroidite                         spheroidite                spheroidite
    186  spheroidite                         spheroidite                spheroidite
    187  spheroidite                         spheroidite                spheroidite
    188  spheroidite                         spheroidite                spheroidite
    189  spheroidite                         spheroidite                spheroidite
    190  spheroidite                         spheroidite  spheroidite+widmanstatten
    191  spheroidite                         spheroidite                spheroidite
    192  spheroidite                         spheroidite                spheroidite
    193  spheroidite                         spheroidite                spheroidite
    194  spheroidite                         spheroidite                spheroidite
    195  spheroidite                         spheroidite                spheroidite
    196  spheroidite                         spheroidite                spheroidite
    197  spheroidite                         spheroidite                spheroidite
    198  spheroidite                         spheroidite                spheroidite
    199  spheroidite                         spheroidite                spheroidite
    200  spheroidite                         spheroidite                spheroidite
    201  spheroidite                         spheroidite                spheroidite
    202  spheroidite                         spheroidite                spheroidite
    203  spheroidite                         spheroidite                spheroidite
    204  spheroidite                         spheroidite                spheroidite
    205  spheroidite                         spheroidite                spheroidite
    206  spheroidite                         spheroidite                spheroidite
    207  spheroidite                         spheroidite                spheroidite
    208  spheroidite                         spheroidite                spheroidite
    209  spheroidite                         spheroidite                spheroidite
    210  spheroidite                         spheroidite                spheroidite
    211  spheroidite                         spheroidite                spheroidite
    212  spheroidite                         spheroidite                spheroidite
    213  spheroidite                         spheroidite                spheroidite
    214  spheroidite                         spheroidite                spheroidite
    215  spheroidite                         spheroidite                spheroidite
    216  spheroidite                         spheroidite                spheroidite
    217  spheroidite                         spheroidite                spheroidite
    218  spheroidite                         spheroidite  spheroidite+widmanstatten
    219     pearlite                            pearlite                   pearlite
    220  spheroidite                         spheroidite                spheroidite
    221  spheroidite                         spheroidite                spheroidite
    222  spheroidite                         spheroidite                spheroidite
    223     pearlite                            pearlite                   pearlite
    224     pearlite                            pearlite                   pearlite
    225  spheroidite                         spheroidite                spheroidite
    226  spheroidite                         spheroidite                spheroidite
    227     pearlite                            pearlite                   pearlite
    228  spheroidite                         spheroidite                spheroidite
    229  spheroidite                         spheroidite                spheroidite
    230  spheroidite                         spheroidite                spheroidite
    231  spheroidite                         spheroidite                spheroidite
    232  spheroidite                         spheroidite                spheroidite
    233  spheroidite                         spheroidite                    network
    234  spheroidite                         spheroidite                spheroidite
    235  spheroidite                         spheroidite  spheroidite+widmanstatten
    236  spheroidite                         spheroidite                spheroidite
    237  spheroidite                         spheroidite                spheroidite
    238     pearlite                            pearlite                   pearlite
    239     pearlite                            pearlite                   pearlite
    240  spheroidite                         spheroidite                spheroidite
    241     pearlite                            pearlite                   pearlite
    242     pearlite                            pearlite                   pearlite
    243  spheroidite                         spheroidite                spheroidite
    244  spheroidite                         spheroidite                spheroidite
    245  spheroidite                         spheroidite                spheroidite
    246  spheroidite                         spheroidite                spheroidite
    247  spheroidite                         spheroidite                spheroidite
    248  spheroidite                         spheroidite                spheroidite
    249  spheroidite                         spheroidite                spheroidite
    250  spheroidite                         spheroidite                spheroidite
    251  spheroidite                         spheroidite                spheroidite
    252     pearlite                            pearlite                   pearlite
    253     pearlite                            pearlite                   pearlite
    254     pearlite                            pearlite                   pearlite
    255     pearlite                            pearlite                   pearlite
    256     pearlite                            pearlite                   pearlite
    257  spheroidite                         spheroidite                spheroidite
    258  spheroidite                         spheroidite                spheroidite
    259  spheroidite                         spheroidite                spheroidite
    260  spheroidite                         spheroidite                spheroidite
    261  spheroidite                         spheroidite                spheroidite
    262  spheroidite                         spheroidite                spheroidite
    263  spheroidite                         spheroidite                spheroidite
    264  spheroidite                         spheroidite                spheroidite
    265  spheroidite                         spheroidite                spheroidite
    266  spheroidite                         spheroidite                spheroidite
    267     pearlite                            pearlite                   pearlite
    268     pearlite                            pearlite                   pearlite
    269  spheroidite                         spheroidite                spheroidite
    270     pearlite                            pearlite                   pearlite
    271  spheroidite                         spheroidite                spheroidite
    272  spheroidite                         spheroidite                spheroidite
    273  spheroidite                         spheroidite                spheroidite
    274     pearlite                            pearlite                   pearlite
    275     pearlite                            pearlite                   pearlite
    276  spheroidite                         spheroidite                spheroidite
    277     pearlite                            pearlite                   pearlite
    278  spheroidite                         spheroidite                spheroidite
    279  spheroidite                         spheroidite                spheroidite
    280  spheroidite                         spheroidite                spheroidite
    281  spheroidite                         spheroidite                spheroidite
    282  spheroidite                         spheroidite                spheroidite
    283  spheroidite                         spheroidite                spheroidite
    284  spheroidite                         spheroidite                spheroidite
    285  spheroidite                         spheroidite                spheroidite
    286     pearlite                            pearlite                   pearlite
    287     pearlite                            pearlite                   pearlite
    288  spheroidite                         spheroidite                spheroidite
    289  spheroidite                         spheroidite                spheroidite
    290  spheroidite                         spheroidite                spheroidite
    291  spheroidite                         spheroidite                spheroidite
    292  spheroidite                         spheroidite                spheroidite
    293     pearlite                            pearlite                   pearlite
    294  spheroidite                         spheroidite                spheroidite
    295  spheroidite                         spheroidite                spheroidite
    296     pearlite                            pearlite                   pearlite
    297     pearlite                            pearlite                   pearlite

### (d)

> Now apply the multilabel classifier on the pearlite + Widmanst¨atten
> and martensite micrographs and print the predicted labels. Compare to
> the results in part (c)

``` python
df_micro2 = df_micro2[(df_micro2["primary_microconstituent"] == "pearlite+widmanstatten") |\
(df_micro2["primary_microconstituent"] == "martensite")]

# Encode labels
le2 = preprocessing.LabelEncoder()
le2.fit(df_micro2["primary_microconstituent"].unique())
list(le2.classes_)
```

    ['martensite', 'pearlite+widmanstatten']

``` python
dlabel2 = le2.transform(df_micro2["primary_microconstituent"])
df_micro2.insert(2, "label", dlabel2)
```

``` python
df_micro2
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>path</th>
      <th>primary_microconstituent</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>15</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph20.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph41.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
    <tr>
      <th>31</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph44.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
    <tr>
      <th>63</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph99.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph114.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>892</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1599.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
    <tr>
      <th>936</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1684.tif</td>
      <td>pearlite+widmanstatten</td>
      <td>1</td>
    </tr>
    <tr>
      <th>942</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1697.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
    <tr>
      <th>944</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1700.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
    <tr>
      <th>956</th>
      <td>data/CMU-UHCS_Dataset/images/micrograph1723.tif</td>
      <td>martensite</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>63 rows × 3 columns</p>
</div>

``` python
# Feature extraction with VGG16
if os.path.exists(os.path.join(dpath, "feature_test2.pkl")) == False:
    fs_test2 = np.zeros((df_micro2.shape[0], out_shapes[-1]))
    m = "block5_pool"
    for j, ph in tqdm(enumerate(df_micro2["path"])):
        x = load_image(ph)
        xb = extmodel[m].predict(x, verbose = 0) # silence output
        F = np.mean(xb,axis=(0,1,2))
        # Save features
        fs_test2[j, :] = F

    # Save data
    ## Create new files
    fs_test2_p = open(os.path.join(dpath, "feature_test2.pkl"), "wb")
    ## Write
    pickle.dump(fs_test2, fs_test2_p)
    ## Close files
    fs_test2_p.close()
```

``` python
#load data
fs_test2_p  = open(os.path.join(dpath, "feature_test2.pkl"), "rb")
fs_test2 = pickle.load(fs_test2_p) # train feature
fs_test2_p .close()
```

``` python
pred_multi2 = clf.predict(fs_test2)

res_ps2 = pd.DataFrame({"Test Label": le2.inverse_transform(df_micro2["label"]),\
              "Multi-OnevsOne": le.inverse_transform(pred_multi2)})

print(res_ps2.to_string())
```

                    Test Label             Multi-OnevsOne
    0               martensite                spheroidite
    1               martensite                    network
    2               martensite                   pearlite
    3               martensite                spheroidite
    4               martensite                spheroidite
    5               martensite                    network
    6               martensite                spheroidite
    7   pearlite+widmanstatten                   pearlite
    8               martensite                   pearlite
    9               martensite                spheroidite
    10              martensite                spheroidite
    11  pearlite+widmanstatten                   pearlite
    12              martensite                   pearlite
    13  pearlite+widmanstatten                   pearlite
    14              martensite                   pearlite
    15  pearlite+widmanstatten                spheroidite
    16  pearlite+widmanstatten  spheroidite+widmanstatten
    17  pearlite+widmanstatten                   pearlite
    18              martensite                   pearlite
    19  pearlite+widmanstatten                spheroidite
    20  pearlite+widmanstatten                   pearlite
    21  pearlite+widmanstatten                spheroidite
    22  pearlite+widmanstatten                spheroidite
    23  pearlite+widmanstatten                   pearlite
    24  pearlite+widmanstatten                   pearlite
    25              martensite                   pearlite
    26              martensite                spheroidite
    27              martensite                   pearlite
    28              martensite                spheroidite
    29              martensite                   pearlite
    30              martensite                spheroidite
    31              martensite                   pearlite
    32  pearlite+widmanstatten                   pearlite
    33              martensite                   pearlite
    34              martensite                spheroidite
    35  pearlite+widmanstatten                spheroidite
    36              martensite                spheroidite
    37  pearlite+widmanstatten                spheroidite
    38  pearlite+widmanstatten                   pearlite
    39  pearlite+widmanstatten                   pearlite
    40              martensite                   pearlite
    41              martensite                spheroidite
    42  pearlite+widmanstatten                   pearlite
    43  pearlite+widmanstatten                spheroidite
    44  pearlite+widmanstatten  spheroidite+widmanstatten
    45  pearlite+widmanstatten                   pearlite
    46  pearlite+widmanstatten                   pearlite
    47              martensite                   pearlite
    48  pearlite+widmanstatten                   pearlite
    49              martensite                   pearlite
    50  pearlite+widmanstatten  spheroidite+widmanstatten
    51  pearlite+widmanstatten                   pearlite
    52              martensite                   pearlite
    53  pearlite+widmanstatten                spheroidite
    54              martensite                spheroidite
    55              martensite                spheroidite
    56              martensite                   pearlite
    57              martensite                    network
    58              martensite                spheroidite
    59  pearlite+widmanstatten                   pearlite
    60              martensite                spheroidite
    61              martensite                   pearlite
    62              martensite                spheroidite
